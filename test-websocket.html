<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background: #90EE90; }
        .disconnected { background: #FFB6C1; }
        .connecting { background: #FFE4B5; }
        #log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>

    <div id="status" class="disconnected">Status: Not Connected</div>

    <button onclick="testSimpleWebSocket()">Test Simple WebSocket (No Auth)</button>
    <button onclick="testAuthWebSocket()">Test Auth WebSocket (With Token)</button>
    <button onclick="clearLog()">Clear Log</button>

    <h3>Log:</h3>
    <div id="log"></div>

    <script>
        let ws = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(message, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.className = className;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testSimpleWebSocket() {
            log('='.repeat(60));
            log('Testing SIMPLE WebSocket (no auth)...');

            if (ws) {
                ws.close();
            }

            setStatus('Connecting...', 'connecting');

            ws = new WebSocket('ws://localhost:8000/test-ws');

            ws.onopen = () => {
                log('âœ… WebSocket CONNECTED!');
                setStatus('Connected', 'connected');

                // Send test message
                ws.send('ping');
                log('ðŸ“¤ Sent: ping');
            };

            ws.onmessage = (event) => {
                log('ðŸ“¥ Received: ' + event.data);
            };

            ws.onerror = (error) => {
                log('âŒ ERROR: ' + JSON.stringify(error));
                setStatus('Error', 'disconnected');
            };

            ws.onclose = (event) => {
                log(`ðŸ”Œ Disconnected - Code: ${event.code}, Reason: ${event.reason}`);
                setStatus('Disconnected', 'disconnected');
            };
        }

        function testAuthWebSocket() {
            log('='.repeat(60));
            log('Testing AUTH WebSocket (with token)...');

            // Get token from localStorage (if you're logged in)
            const token = localStorage.getItem('access_token');

            if (!token) {
                log('âŒ ERROR: No token found in localStorage');
                log('ðŸ’¡ Please login to your app first, then try again');
                return;
            }

            log('âœ“ Token found: ' + token.substring(0, 20) + '...');

            if (ws) {
                ws.close();
            }

            setStatus('Connecting...', 'connecting');

            const wsUrl = `ws://localhost:8000/api/projects/ws?token=${token}`;
            log('ðŸ”Œ Connecting to: ' + wsUrl);

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log('âœ… WebSocket CONNECTED!');
                setStatus('Connected', 'connected');

                // Send ping
                ws.send('ping');
                log('ðŸ“¤ Sent: ping');
            };

            ws.onmessage = (event) => {
                log('ðŸ“¥ Received: ' + event.data);
            };

            ws.onerror = (error) => {
                log('âŒ ERROR: ' + JSON.stringify(error));
                setStatus('Error', 'disconnected');
            };

            ws.onclose = (event) => {
                log(`ðŸ”Œ Disconnected - Code: ${event.code}, Reason: ${event.reason}`);
                setStatus('Disconnected', 'disconnected');
            };
        }

        // Auto-test on page load
        log('WebSocket Test Page Loaded');
        log('Click buttons above to test WebSocket connections');
    </script>
</body>
</html>
